# Step by Step Guide to install AWS IAM Group with Permssions to create EKS cluster
> Note: The IAM policy can be only created with "Admin" role. This step needs to be executed only once per account by the admin.


### Step 1. Install required software(s)

This repo contains scripts/prereq.sh file that will install all the required softwares based on the OS (tested on MacOS and Ubuntu)

Upon running the script the following software/tools will be installed

1. Terraform
2. GIT
3. Docker
4. AWScli

For additional details and instructions on above installing above softwares are defined at [readme.md](../../README.md)


### Step 2. Download the IaC code

Download the latest source from [git](https://github.com/PureStorage-OpenConnect/k8s-px-terraform.git) to have latest terraform-iac library

If you already have the repo downloaded, git pull command will bring the latest code from the GIT master

```
    git clone https://github.com/PureStorage-OpenConnect/k8s-px-terraform.git

```

### Step 3. Setup AWS Profile

The AWS CLI stores sensitive credential information that you specify with `aws configure` in a local file named credentials, in a folder named .aws in your home directory.

```
aws configure
```
In case you want setup new AWS profile, more information can be found [here.](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-profiles.html)

For example, the files generated by the AWS CLI for a default profile configured with aws configure looks similar to the following.

~/.aws/credentials

```
[default]
aws_access_key_id=AKIAIOSFODNN7EXAMPLE
aws_secret_access_key=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY

[purestorage-dev]
aws_access_key_id=ALIATHISODNN7EXAMPLE
aws_secret_access_key=wJalrXUtnFEMI/K7EXXY/bPxRfiCYEXAMPLEKEY

```

Export AWS profile by pointing to the desired account.

```
export AWS_PROFILE=<purestorage_dev> -- Please ensure that this entry exists in the ~/.aws/credentials file

Test connectivity: 
aws s3 ls

```

You will need access_key and secret_key of your AWS account

This profile is going to be used for creating the EKS Cluster

NOTE: This same keys are also used to provision portworx storage as well


### 4. Navigate to scripts folder and Run setup_env.sh <param1> <param2> <param3>

```
./setup_env.sh <Provider> <UniqueIdForCluster> <ZoneName>

./setup_env.sh help

AWS IAM example:
 ~/PureStorage-OpenConnect/terraform-iac/scripts (master) âš¡ :./setup_env.sh aws 896853494200 global
 
The first parameter in this scenario has to be "aws"
The second parameter is used just for readability
The third parameter has to be "global"


## Step 5: AWS IAM Permissions

Only Admins can execute and create the new "User" Group with all custom polices and AWS managed polices assocaited


***** NOTE: Users needs to be assigned manually to this newly created group *****

```


./setup_env.sh aws 1234567 global

    terraform init
    terraform validate
    terraform plan -out "plan.out"
    terraform apply "plan.out"
    
Note: If Error mentions policy already exists, that error can be ignored as the policy has already been created by the user.

```

If you want to create manually from UI:

Login to AWS console, Navigate to IAM 

Step 1: Create a custom policy that has limited IAM access and additional EKS custom permissions, the policy json is located in terraform-iac/scripts/eks-custom-iam.json

Step 2: Add the following AWS managed Policies to the user/group
```
AmazonEC2FullAccess
AmazonEKSClusterPolicy
AmazonEKSWorkerNodePolicy
AmazonS3ReadOnlyAccess
AmazonEKSServicePolicy
AmazonEKS_CNI_Policy
AmazonEKSFargatePodExecutionRolePolicy
AmazonEKSVPCResourceController
```


This completes the creation of IAM Groups with required policies




## Cleanup steps:

Step 1: Navigate to the folder where the original terraform was executed to create the "aws iam user group"

Step 2: Export desired AWS account profile (Skip if already exported) and then run the terraform destroy command:

```
export AWS_PROFILE=purestorage_aws_dev
terraform destroy -auto-approve
```

Note: the terraform destroy command needs to be executed from the same location as terraform apply command. 



## References:

Install AWSCLI Guide - https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html

Setup AWS Keypair - https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html#having-ec2-create-your-key-pair

Install GCloud SDK Guide - https://cloud.google.com/sdk/docs/quickstart

Install Azure Cli Guide - https://docs.microsoft.com/en-us/cli/azure/install-azure-cli-macos

Install and Configure GIT - https://git-scm.com/book/en/v2/Getting-Started-Installing-Git



## Contributing
Pull requests are welcome. For major changes, please open an issue first to discuss what you would like to change.

Please make sure to update tests as appropriate.
